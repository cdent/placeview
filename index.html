<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>placement viz</title>
	<meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
	<h1>placement viz</h1>
	<placement-graph src="https://gist.githubusercontent.com/cdent/d01fe797de38ec583e74367ccde130ef/raw/6da255b4785c5880961b2d9ab438587388b3a11d/allocation_candidates2.json" width="960" height="480"></placement-graph>

	<script src="https://d3js.org/d3.v5.min.js"></script>
	<script>
(function() {

class PlacementGraph extends HTMLElement {
	connectedCallback() {
		let uri = this.getAttribute("src");
		d3.json(uri).
			then(({ provider_summaries }) => {
				let data = transform(provider_summaries);
				this.render(data);
			});
	}

	render({ nodes, links }) {
		let width = this.getAttribute("width");
		let height = this.getAttribute("height");
		renderGraph({ nodes, links }, this, width, height);
	}
}

customElements.define("placement-graph", PlacementGraph);

function renderGraph({ nodes, links }, root, width, height) {
	let svg = d3.select(root).append("svg").
			attr("viewBox", `0, 0, ${width}, ${height}`).
			attr("width", width).
			attr("height", height);

	let simulation = d3.forceSimulation(nodes).
			force("link", d3.forceLink(links).id(d => d.id)).
			force("charge", d3.forceManyBody()).
			force("center", d3.forceCenter(width / 2, height / 2));

	let link = svg.append("g").
			attr("stroke", "#999").
			attr("stroke-opacity", 0.6).
		selectAll("line").
		data(links).
		join("line").
			attr("stroke-width", "1");

	let node = svg.append("g").
			attr("stroke", "#fff").
			attr("stroke-width", 1.5).
		selectAll("circle").
		data(nodes).
		join("circle").
			attr("r", 5).
			attr("fill", "red").
			call(drag(simulation));

	node.append("title").
			text(d => d.id);

	simulation.on("tick", () => {
		link.
				attr("x1", d => d.source.x).
				attr("y1", d => d.source.y).
				attr("x2", d => d.target.x).
				attr("y2", d => d.target.y);

		node.
				attr("cx", d => d.x).
				attr("cy", d => d.y);
	});

	return svg.node();
}

function drag(simulation) {
	function dragstarted(d) {
		if(!d3.event.active) {
			simulation.alphaTarget(0.3).restart();
		}
		d.fx = d.x;
		d.fy = d.y;
	}

	function dragged(d) {
		d.fx = d3.event.x;
		d.fy = d3.event.y;
	}

	function dragended(d) {
		if(!d3.event.active) {
			simulation.alphaTarget(0);
		}
		d.fx = null;
		d.fy = null;
	}

	return d3.drag().
			on("start", dragstarted).
			on("drag", dragged).
			on("end", dragended);
}

function transform(data) {
	let nodes = [];
	let links = [];
	Object.entries(data).forEach(([id,
			{ parent_provider_uuid: parentID, traits, resources }]) => {
		let node = { id, resources, traits };
		if(parentID) {
			links.push({ source: parentID, target: id });
		} else {
			node.root = true;
		}
		nodes.push(node);
	});
	return { nodes, links };
}

}());
	</script>
</body>

</html>
